<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word Psychic</title>
<link rel="icon" href="data:," />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg0:#050914;
    --bg1:#071024;

    --ink:#e9f3ff;
    --muted:#a8c1dc;

    --pill: rgba(14, 26, 54, .70);
    --pillEdge: rgba(210,230,255,.18);

    --panelEdge: rgba(210,230,255,.18);

    /* purple bias */
    --violetA: rgba(190,120,255,.14);
    --violetB: rgba(140, 90,255,.10);
    --violetC: rgba(220,140,255,.08);
  }

  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    background:
      radial-gradient(1200px 700px at 50% 45%, var(--violetA), rgba(0,0,0,0) 60%),
      radial-gradient(900px  520px at 50% 55%, var(--violetB), rgba(0,0,0,0) 65%),
      radial-gradient(1400px 900px at 50% 120%, var(--violetC), rgba(0,0,0,0) 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }

  .wrap{
    width:min(1200px, calc(100% - 56px));
    margin: 18px auto 24px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    padding-bottom: 14px;
  }

  .topbar{ display:flex; justify-content:center; position:relative; z-index:10; }
  .controls{
    display:flex;
    align-items:center;
    gap: 18px;
    padding: 16px 18px;
    border-radius: 18px;
    background: var(--pill);
    border: 1px solid var(--pillEdge);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 18px 60px rgba(0,0,0,.50);
    width:min(1040px, 100%);
    justify-content:center;
  }
  .controls label{ font-size: 16px; line-height: 1; gap: 10px; }
  .controls select{
    font-size: 16px;
    line-height: 1;
    height: 38px;
    padding: 0 12px;
    border-radius: 12px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.14);
    color: var(--ink);
    outline:none;
    min-width: 120px;
  }
  .controls input[type="checkbox"]{
    transform: scale(1.05);
    accent-color: #7ad3ff;
  }
  .controls .start{
    margin-left: 14px;
    padding: 12px 30px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 650;
    letter-spacing: .02em;
    color: rgba(235,250,255,.98);
    background: linear-gradient(180deg, rgba(120,220,255,.22), rgba(255,255,255,.06));
    border: 1px solid rgba(140,220,255,.36);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.10),
      0 10px 28px rgba(0,0,0,.42),
      0 0 0 1px rgba(120,220,255,.12);
    cursor:pointer;
    transition: transform .15s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .controls .start:hover{
    transform: translateY(-1px);
    background: linear-gradient(180deg, rgba(140,235,255,.26), rgba(255,255,255,.08));
    border-color: rgba(160,245,255,.46);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.12),
      0 14px 34px rgba(0,0,0,.48),
      0 0 34px rgba(120,220,255,.12);
  }
  .controls .start:active{ transform: translateY(0px); }
  .controls .start:focus-visible{
    outline: none;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.12),
      0 14px 34px rgba(0,0,0,.48),
      0 0 0 3px rgba(120,220,255,.22);
  }
  .controls .start[disabled]{
    opacity:.55;
    cursor:not-allowed;
    transform:none;
  }

  .title-wrap{ display:flex; justify-content:center; margin-top: 0; position:relative; z-index:9; }
  .title{
    font-family: "Cinzel Decorative", system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    font-size: 38px;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: rgba(240,232,255,.92);
    opacity: 0;
    transform: translateY(-10px);
    text-shadow:
      0 0 18px rgba(200,140,255,.30),
      0 0 34px rgba(160,120,255,.18);
    transition: opacity 2.2s ease, transform 2.2s ease;
    user-select:none;
  }
  .title.visible{ opacity: 1; transform: translateY(0); }

  .hero-row{
    position:relative;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height: 340px;
    padding-top: 0px;
    padding-bottom: 12px;
  }

  .side-icons{
    position:absolute;
    left: 8px;
    top: 54%;
    transform: translateY(-50%);
    display:flex;
    flex-direction:column;
    gap: 18px;
    align-items:flex-start;
    z-index: 5;
  }

  .icon-link{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 8px;
    width: 92px;
    text-decoration:none;
    color: var(--muted);
    user-select:none;
  }
  .icon-btn{
    width: 58px;
    height: 58px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.16);
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(200,140,255,.18), rgba(0,0,0,0) 55%),
      rgba(255,255,255,.05);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 14px 40px rgba(0,0,0,.38);
    display:grid;
    place-items:center;
    transition: transform .15s ease, background .15s ease, border-color .15s ease;
    overflow: hidden;
  }
  .icon-link:hover .icon-btn{
    transform: translateY(-1px);
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(210,155,255,.22), rgba(0,0,0,0) 55%),
      rgba(255,255,255,.08);
    border-color: rgba(170,220,255,.30);
  }
  .icon-label{ font-size: 14px; letter-spacing:.02em; }

  .ico-img{
    width: 52px;
    height: 52px;
    display:block;
    object-fit: cover;
    border-radius: 12px;
    image-rendering: auto;
    filter:
      saturate(1.25)
      contrast(1.05)
      drop-shadow(0 0 10px rgba(190,140,255,.22))
      drop-shadow(0 10px 24px rgba(0,0,0,.35));
    opacity: .98;
  }

  .stage{ width: 100%; display:flex; justify-content:center; align-items:center; }

  /* ===== CRYSTAL ===== */
  #ballWrap{
    position:relative;
    width: 320px;
    aspect-ratio: 1 / 1;
    margin: 0 auto;
    z-index: 2;
    filter: drop-shadow(0 46px 110px rgba(0,0,0,.72));
    --beatScale: 1.0015;
  }

  .radiate, .aura, .aura2{ z-index: 0; }

  .radiate{
    position:absolute;
    inset:-70%;
    border-radius:50%;
    pointer-events:none;
    background:
      radial-gradient(circle at 50% 58%,
        rgba(220,185,255,.20) 0%,
        rgba(190,140,255,.12) 18%,
        rgba(170,120,255,.07) 34%,
        rgba(170,120,255,0) 70%);
    filter: blur(30px);
    opacity:.88;
    transition: opacity 140ms ease-out, filter 140ms ease-out;
  }

  .aura{
    position:absolute;
    inset:-34%;
    border-radius:50%;
    pointer-events:none;
    background: radial-gradient(circle,
      rgba(210,160,255,.26) 0%,
      rgba(170,140,255,.10) 32%,
      rgba(170,140,255,0) 76%);
    filter: blur(22px);
    opacity:.70;
    transition: opacity 140ms ease-out, filter 140ms ease-out;
  }
  .aura2{
    position:absolute;
    inset:-22%;
    border-radius:50%;
    pointer-events:none;
    background: radial-gradient(circle at 50% 62%,
      rgba(190,140,255,.22) 0%,
      rgba(190,140,255,0) 72%);
    filter: blur(38px);
    opacity:.58;
    transition: opacity 140ms ease-out, filter 140ms ease-out;
  }

  .ball{
    position:absolute;
    inset:0;
    border-radius:50%;
    overflow:hidden;
    z-index: 6;
    background:
      radial-gradient(circle at 50% 16%,
        rgba(8,6,18,.72) 0%,
        rgba(14,10,30,.46) 28%,
        rgba(92,110,210,.24) 58%,
        rgba(190,160,255,.46) 82%,
        rgba(230,215,255,.18) 100%),
      radial-gradient(circle at 50% 92%,
        rgba(245,235,255,.72) 0%,
        rgba(190,160,255,.18) 34%,
        rgba(30,22,60,.12) 74%,
        rgba(0,0,0,0) 100%);
    border: none;

    box-shadow:
      0 0 0 1px rgba(240,255,255,.10),
      0 0 52px rgba(180,245,255,.18),
      0 0 130px rgba(160,240,255,.12),
      inset 0 0 110px rgba(255,255,255,.10),
      inset 0 -130px 260px rgba(0,0,0,.18),
      inset 0 0 0 1px rgba(235,215,255,.10);

    transform-origin: 50% 102%;
    transform: scale(var(--beatScale));
    transition: transform 120ms ease-out;
    will-change: transform;
  }

  .ball::before{
    content:"";
    position:absolute;
    inset:-10%;
    border-radius:50%;
    pointer-events:none;
    background:
      radial-gradient(circle at 30% 18%,
        rgba(255,255,255,.62) 0%,
        rgba(255,255,255,.18) 18%,
        rgba(255,255,255,0) 46%),
      radial-gradient(circle at 80% 34%,
        rgba(230,255,255,.22) 0%,
        rgba(230,255,255,0) 48%),
      radial-gradient(circle,
        rgba(255,255,255,.12) 0%,
        rgba(255,255,255,0) 60%);
    transform: rotate(-10deg);
    opacity:.92;
  }

  .ball::after{
    content:"";
    position:absolute;
    inset:-12%;
    border-radius:50%;
    pointer-events:none;
    background:
      radial-gradient(circle at 50% 94%,
        rgba(245,255,255,.66) 0%,
        rgba(170,245,255,.18) 26%,
        rgba(170,245,255,0) 60%);
    opacity:.82;
  }

  .contactFade{
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    bottom:-8px;
    width: 330px;
    height: 150px;
    pointer-events:none;
    z-index: 7;
    border-radius: 999px;
    background:
      radial-gradient(ellipse at 50% 0%,
        rgba(0,0,0,.42) 0%,
        rgba(0,0,0,.22) 34%,
        rgba(0,0,0,0) 72%);
    filter: blur(12px);
    opacity: .44;
    mix-blend-mode: multiply;
  }

  .rimHard{
    position:absolute;
    inset:0;
    border-radius:50%;
    pointer-events:none;
    background:
      radial-gradient(circle at 50% 50%,
        rgba(255,255,255,0) 67.9%,
        rgba(255,255,255,.42) 68.7%,
        rgba(255,255,255,.08) 69.8%,
        rgba(255,255,255,0) 71.3%);
    mix-blend-mode: screen;
    opacity: .50;
    filter: blur(.35px);
  }
  .rimInner{
    position:absolute;
    inset:2%;
    border-radius:50%;
    pointer-events:none;
    background:
      radial-gradient(circle at 50% 50%,
        rgba(255,255,255,0) 66.8%,
        rgba(210,180,255,.14) 68.4%,
        rgba(20,18,40,.12) 69.6%,
        rgba(255,255,255,0) 71.2%);
    mix-blend-mode: screen;
    opacity: .38;
    filter: blur(.6px);
  }

  .sparkles{
    position:absolute;
    inset:-2%;
    border-radius:50%;
    pointer-events:none;
    mix-blend-mode: screen;
    opacity: .05;
    filter: blur(.15px);
    transition: opacity 180ms ease, filter 180ms ease;
    background:
      radial-gradient(circle at 18% 32%, rgba(255,255,255,.95) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 28% 18%, rgba(210,255,255,.70) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 72% 14%, rgba(255,255,255,.75) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 84% 26%, rgba(190,255,255,.70) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 90% 54%, rgba(255,255,255,.70) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 78% 78%, rgba(190,255,255,.55) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 46% 90%, rgba(255,255,255,.55) 0 1px, rgba(255,255,255,0) 3px),
      radial-gradient(circle at 14% 70%, rgba(190,255,255,.55) 0 1px, rgba(255,255,255,0) 3px);
  }

  .swirlA,.swirlB,.swirlC{
    position:absolute;
    inset:-18%;
    border-radius:50%;
    pointer-events:none;
    opacity:.66;
    filter: blur(18px);
    mix-blend-mode: screen;
  }
  .swirlA{
    background:
      conic-gradient(from 220deg,
        rgba(200,255,255,0) 0%,
        rgba(200,255,255,.20) 14%,
        rgba(200,255,255,0) 30%,
        rgba(170,245,255,.14) 54%,
        rgba(200,255,255,0) 74%,
        rgba(200,255,255,.12) 90%,
        rgba(200,255,255,0) 100%),
      radial-gradient(52% 44% at 56% 56%,
        rgba(190,255,255,.22),
        rgba(190,255,255,0) 72%);
    animation: swirlA 10s ease-in-out infinite alternate;
  }
  .swirlB{
    opacity:.54;
    filter: blur(24px);
    background:
      conic-gradient(from 40deg,
        rgba(150,230,255,0) 0%,
        rgba(150,230,255,.18) 18%,
        rgba(150,230,255,0) 40%,
        rgba(120,210,255,.14) 62%,
        rgba(150,230,255,0) 80%,
        rgba(150,230,255,.12) 94%,
        rgba(150,230,255,0) 100%),
      radial-gradient(46% 38% at 44% 48%,
        rgba(140,220,255,.18),
        rgba(140,220,255,0) 74%);
    animation: swirlB 14s ease-in-out infinite alternate;
  }
  .swirlC{
    opacity:.30;
    filter: blur(30px);
    mix-blend-mode: multiply;
    background: radial-gradient(58% 42% at 52% 22%,
      rgba(0,0,0,.30),
      rgba(0,0,0,0) 72%);
    animation: storm 9s ease-in-out infinite alternate;
  }

  @keyframes swirlA{ from{ transform: translate(-10px,-6px) rotate(-6deg)} to{ transform: translate(12px,10px) rotate(10deg)} }
  @keyframes swirlB{ from{ transform: translate(12px,10px) rotate(12deg)} to{ transform: translate(-12px,-10px) rotate(-10deg)} }
  @keyframes storm{  from{ transform: translate(-10px,0px) scale(1.02)} to{ transform: translate(10px,8px) scale(0.98)} }

  .mist,.mist2{
    position:absolute;
    inset:-18%;
    border-radius:50%;
    pointer-events:none;
    filter: blur(22px);
    mix-blend-mode: screen;
    opacity:.92;
    z-index: 1;
  }
  .mist{
    background: radial-gradient(64% 46% at 50% 56%,
      rgba(190,160,255,.16),
      rgba(190,160,255,0) 74%);
    animation: drift 7s ease-in-out infinite alternate;
  }
  .mist2{
    background: radial-gradient(60% 42% at 46% 78%,
      rgba(170,140,255,.13),
      rgba(170,140,255,0) 76%);
    animation: drift2 9.5s ease-in-out infinite alternate;
  }
  @keyframes drift{ from{transform:translateY(-8px)} to{transform:translateY(8px)} }
  @keyframes drift2{ from{transform:translateX(-10px)} to{transform:translateX(10px)} }

  /* ===== BASE ===== */
  .ground-glow{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:-98px;
    width: 620px;
    height: 235px;
    background: radial-gradient(circle at 50% 26%,
      rgba(200,255,255,.28) 0%,
      rgba(140,220,255,.12) 26%,
      rgba(140,220,255,0) 74%);
    filter: blur(28px);
    opacity:.88;
    pointer-events:none;
    transition: opacity 140ms ease-out, filter 140ms ease-out;
    z-index: 0;
  }

  .seatShadow{
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    bottom: -6px;
    width: 238px;
    height: 42px;
    pointer-events:none;
    z-index: 3;
    opacity: .88;
    filter: blur(6px);
    background:
      radial-gradient(ellipse at 50% 40%,
        rgba(0,0,0,.58) 0%,
        rgba(0,0,0,.34) 28%,
        rgba(0,0,0,0) 72%),
      radial-gradient(ellipse at 50% 15%,
        rgba(200,255,255,.12) 0%,
        rgba(200,255,255,0) 60%);
    mix-blend-mode: multiply;
  }

  .cradle{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:-9px;
    width: 244px;
    height: 28px;
    border-radius: 999px;
    pointer-events:none;
    z-index: 4;
    background:
      radial-gradient(ellipse at 50% 20%,
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,0) 52%,
        rgba(255,255,255,.05)56%,
        rgba(130,220,255,.12) 62%,
        rgba(10,16,30,.88) 70%,
        rgba(0,0,0,0) 78%),
      linear-gradient(180deg,
        rgba(255,255,255,.06),
        rgba(255,255,255,0));
    border: 1px solid rgba(170,240,255,.16);
    box-shadow:
      0 10px 22px rgba(0,0,0,.40),
      inset 0 1px 0 rgba(255,255,255,.08);
    opacity: .95;
  }

  .pedestal{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:-32px;
    width: 312px;
    height: 32px;
    border-radius: 999px;
    pointer-events:none;
    z-index: 2;
    background:
      radial-gradient(150px 16px at 50% 18%,
        rgba(255,255,255,.10),
        rgba(255,255,255,0) 72%),
      linear-gradient(180deg,
        rgba(18,34,68,.74),
        rgba(6,10,18,.98));
    border: 1px solid rgba(200,245,255,.12);
    box-shadow:
      0 30px 80px rgba(0,0,0,.60),
      inset 0 1px 0 rgba(255,255,255,.08),
      inset 0 -14px 18px rgba(0,0,0,.50);
  }

  .pedestal::before{
    content:"";
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    bottom:-12px;
    width: 372px;
    height: 18px;
    border-radius: 999px;
    background: linear-gradient(180deg, rgba(10,16,30,.86), rgba(0,0,0,.94));
    border: 1px solid rgba(120,200,255,.08);
    box-shadow:
      0 16px 54px rgba(0,0,0,.66),
      inset 0 1px 0 rgba(255,255,255,.04);
    opacity:.98;
  }

  .pedestal::after{
    content:"";
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    top: 6px;
    width: 226px;
    height: 16px;
    border-radius: 999px;
    background:
      radial-gradient(120px 10px at 50% 55%,
        rgba(0,0,0,.58),
        rgba(0,0,0,0) 74%),
      linear-gradient(180deg,
        rgba(255,255,255,.06),
        rgba(255,255,255,0));
    opacity:.92;
  }

  /* ===== Glow states ===== */
  #ballWrap.idle .radiate{ opacity:.18; filter: blur(34px); }
  #ballWrap.idle .aura{    opacity:.12; filter: blur(28px); }
  #ballWrap.idle .aura2{   opacity:.10; filter: blur(42px); }
  #ballWrap.idle .ground-glow{ opacity:.12; filter: blur(34px); }

  #ballWrap.speaking .radiate{ opacity:.55; }
  #ballWrap.speaking .aura{ opacity:.44; }
  #ballWrap.speaking .aura2{ opacity:.34; }
  #ballWrap.speaking .ground-glow{ opacity:.42; }

  #ballWrap.beat .radiate{ opacity:1.00; filter: blur(24px); }
  #ballWrap.beat .aura{ opacity:.92; filter: blur(18px); }
  #ballWrap.beat .aura2{ opacity:.78; filter: blur(32px); }
  #ballWrap.beat .ground-glow{ opacity:1.00; filter: blur(22px); }

  /* ===== ACTION BAR ===== */
  .action-bar{
    width:min(1040px, 100%);
    margin: 8px auto 6px;
    display:flex;
    justify-content:center;
    position: relative;
    z-index: 8;
  }
  .action-bar .buttons{
    width:min(560px, 100%);
    display:flex;
    justify-content:center;
    gap: 12px;
    flex-wrap:wrap;
    padding: 8px 12px 10px;
    border-radius: 18px;
    border: 1px solid rgba(210,230,255,.14);
    background: rgba(8,14,28,.26);
    backdrop-filter: blur(8px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 18px 60px rgba(0,0,0,.30);
  }

  button.action{
    min-width: 112px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.05);
    color: var(--ink);
    cursor:pointer;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 14px 40px rgba(0,0,0,.35);
    transition: transform .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    font-size: 15px;
  }
  button.action:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(170,220,255,.26); }
  button.action:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
  button.action.quiet{ background: rgba(255,255,255,.03); border-color: rgba(255,255,255,.11); color: rgba(232,243,255,.86); }
  button.action.placeholder{ opacity: 0; pointer-events: none; }

  /* ===== CONSOLE ===== */
  .console{
    width:min(1040px, 100%);
    margin: 0 auto;
    border-radius: 18px;
    border: 1px solid var(--panelEdge);
    background:
      radial-gradient(900px 260px at 50% 0%, rgba(120,210,255,.10), rgba(0,0,0,0) 60%),
      linear-gradient(180deg, rgba(10,18,36,.86), rgba(6,10,18,.90));
    box-shadow:
      inset 0 0 26px rgba(0,0,0,.58),
      0 26px 70px rgba(0,0,0,.42);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    height: clamp(360px, 44vh, 460px);
    min-height: 340px;
    overflow-anchor: none;
  }

  .screen{
    white-space: pre-wrap;
    padding: 16px 22px;
    flex: 1 1 auto;
    min-height: 0;
    overflow: auto;
    position: relative;
    z-index: 2;
    color: rgba(233,243,255,.94);
    text-shadow: 0 1px 0 rgba(0,0,0,.35);
    background: rgba(0,0,0,.14);
    scrollbar-gutter: stable both-edges;
    overflow-anchor: none;
  }

  .note{
    color: var(--muted);
    font-size: 13px;
    text-align:center;
    margin-top: 2px;
    min-height: 0;
  }

  .footerbar{
    width:min(1040px, 100%);
    margin: 4px auto 0;
    padding: 10px 14px;
    border-radius: 18px;
    border: 1px solid rgba(210,230,255,.14);
    background: rgba(8,14,28,.26);
    backdrop-filter: blur(10px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 18px 60px rgba(0,0,0,.24);
    display:flex;
    justify-content:center;
    gap: 14px;
    flex-wrap: wrap;
    color: rgba(168,193,220,.92);
    font-size: 14px;
    letter-spacing: .01em;
  }
  .footerbar a{
    color: rgba(210,230,255,.92);
    text-decoration: none;
    border-bottom: 1px solid rgba(210,230,255,.18);
  }
  .footerbar a:hover{
    border-bottom-color: rgba(210,230,255,.44);
  }
  .footer-sep{ opacity:.35; }

  @media (max-width: 980px){
    #ballWrap{ width: 300px; }
    .contactFade{ width: 308px; }
    .ground-glow{ width: 560px; height: 220px; }
    .seatShadow{ width: 224px; height: 40px; bottom:-6px; }
    .cradle{ width: 230px; height: 26px; bottom:-9px; }
    .pedestal{ width: 294px; height: 30px; bottom:-30px; }
    .pedestal::before{ width: 350px; height: 16px; bottom:-11px; }
    .side-icons{ left: 4px; }
    .icon-link{ width: 80px; }
    .hero-row{ min-height: 320px; padding-bottom: 10px; }
    .action-bar{ margin-top: 8px; margin-bottom: 6px; }
    .action-bar .buttons{ width:min(520px, 100%); }
    button.action{ min-width: 108px; padding: 10px 12px; font-size: 15px; }
    .console{ height: clamp(340px, 48vh, 440px); min-height: 320px; }
    .screen{ padding: 14px 20px; }
    .footerbar{ font-size: 13px; padding: 10px 12px; }
  }
</style>
</head>

<body>
  <main class="wrap">

    <div class="topbar">
      <div class="controls">
        <label>Pace
          <select id="speed">
            <option value="slow">Slow</option>
            <option value="normal" selected>Normal</option>
            <option value="fast">Fast</option>
          </select>
        </label>

        <label>
          <input type="checkbox" id="speakWhileTyping" checked>
          <span id="voiceLabel">Voice On</span>
        </label>

        <button id="startBtn" class="start">Start</button>
      </div>
    </div>

    <header class="title-wrap" aria-label="Title">
      <div class="title" id="titleText">THE WORD PSYCHIC</div>
    </header>

    <section class="hero-row" aria-label="Word Psychic chamber">
      <nav class="side-icons" aria-label="Links">

        <a class="icon-link" href="https://www.wordhippo.com/" target="_blank" rel="noopener" title="WordHippo (References)" aria-label="References (WordHippo)">
          <div class="icon-btn">
            <img class="ico-img" src="hippo_icon.jpg" alt="WordHippo">
          </div>
          <div class="icon-label">References</div>
        </a>

        <a class="icon-link" href="https://YOUR-PODCAST-FRIENDS-SITE.com" target="_blank" rel="noopener" title="Podcast Friends" aria-label="Podcast Friends">
          <div class="icon-btn">
            <img class="ico-img" src="podcast_icon.jpg" alt="Podcast">
          </div>
          <div class="icon-label">Podcast</div>
        </a>

      </nav>

      <div class="stage">
        <div id="ballWrap" class="idle">
          <div class="radiate"></div>
          <div class="aura"></div>
          <div class="aura2"></div>

          <div class="ball">
            <div class="swirlA"></div>
            <div class="swirlB"></div>
            <div class="swirlC"></div>

            <div class="rimHard"></div>
            <div class="rimInner"></div>
            <div class="sparkles"></div>
          </div>

          <div class="contactFade"></div>

          <div class="mist"></div>
          <div class="mist2"></div>

          <div class="ground-glow"></div>
          <div class="seatShadow"></div>
          <div class="cradle"></div>
          <div class="pedestal"></div>
        </div>
      </div>
    </section>

    <section class="action-bar" aria-label="Actions">
      <div class="buttons">
        <button id="yesBtn" class="action">Yes</button>
        <button id="noBtn"  class="action">No</button>
        <button id="stopBtn" class="action quiet">End session</button>
      </div>
    </section>

    <section class="console" aria-label="Reading console">
      <div id="screen" class="screen">Tap “Start” to summon the Word Psychic…</div>
    </section>

    <div class="note" id="status"></div>

    <footer class="footerbar" aria-label="Footer">
      <span>© 2026 SteveHendricks. All Rights Reserved.</span>
      <span class="footer-sep">|</span>
      <a href="mailto:scwrconfi@gmail.com">scwrconfi@gmail.com</a>
    </footer>

  </main>

<script>
const API = "https://word-psychic-backend.onrender.com";
const LIVE_SYNC = true;

const WHOOSH_MS = 1900;
const WHOOSH_BUFFER_MS = 700;

const ELLIPSIS_DELAY = 2000;
const FINAL_ELLIPSIS_DELAY = 3000;

const SENTENCE_PAUSE_MS   = 140;
const PARAGRAPH_PAUSE_MS  = 900;
const SECTION_PAUSE_MS    = 1200;

let sessionId = null;
let voiceReady = false;
let chosenVoice = null;
let startBound = false;
let titleShown = false;

/* =========================
   Hard guards / tokens
   ========================= */
let runToken = 0;                 // increments to cancel old typing loops
let startInFlight = false;        // prevents double Start
let chooseInFlight = false;       // prevents double Yes/No
let sessionDone = false;          // prevents multiple end-session responses
let currentFetchController = null;

function bumpRunToken(){ runToken++; return runToken; }
function isTokenLive(t){ return t === runToken; }

function abortInFlightFetch(){
  try{ currentFetchController?.abort(); }catch(e){}
  currentFetchController = null;
}

const screenEl = document.getElementById("screen");
const statusEl = document.getElementById("status");
const yesBtn = document.getElementById("yesBtn");
const noBtn = document.getElementById("noBtn");
const stopBtn = document.getElementById("stopBtn");
const startBtn = document.getElementById("startBtn");
const speedSel = document.getElementById("speed");
const speakWhileTyping = document.getElementById("speakWhileTyping");
const voiceLabel = document.getElementById("voiceLabel");
const ballWrap = document.getElementById("ballWrap");
const titleEl = document.getElementById("titleText");

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())); }

function trimLeadingNewlines(s){ return (s ?? "").replace(/^\s*\n+/, ""); }

function tightenQuestionSpacing(s){
  let t = (s ?? "");
  t = t.replace(/\r\n/g, "\n");
  t = t.replace(/\n{3,}/g, "\n\n");
  const qStart = "(Do you\\b|Would you\\b|Shall we\\b|Shall I\\b)";
  t = t.replace(new RegExp(`([^\\n])\\n(?=\\s*${qStart})`, "gi"), "$1\n\n");
  t = t.replace(new RegExp(`\\n{3,}(?=\\s*${qStart})`, "gi"), "\n\n");
  return t;
}

function normalizeCTA(s){
  return tightenQuestionSpacing(
    (s ?? "")
      .replace(/Choose Yes or No\./gi, "Click Yes or No.")
      .replace(/Choose Yes or No/gi, "Click Yes or No")
      .replace(/Choose Yes,\s*No,\s*or End session\./gi, "Click Yes, No, or End session.")
      .replace(/Choose Yes,\s*No,\s*or End session/gi, "Click Yes, No, or End session")
  );
}

function autoScrollScreen(){
  try { screenEl.scrollTop = screenEl.scrollHeight; } catch(e){}
}

/* ===== gentle reset of inner screen only ===== */
let clearing = false;

function smoothScrollToTop(el, duration = 420){
  return new Promise(resolve => {
    const startTop = el.scrollTop;
    const delta = 0 - startTop;
    if (Math.abs(delta) < 2 || duration <= 0){
      el.scrollTop = 0;
      resolve();
      return;
    }
    const start = performance.now();
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
    function tick(now){
      const t = Math.min(1, (now - start) / duration);
      el.scrollTop = startTop + delta * easeOutCubic(t);
      if (t < 1) requestAnimationFrame(tick);
      else resolve();
    }
    requestAnimationFrame(tick);
  });
}

async function gentleResetAndClear(token){
  if (!isTokenLive(token)) return;
  if (clearing) return;
  clearing = true;

  await nextFrame();
  await nextFrame();

  if (!isTokenLive(token)){ clearing=false; return; }

  try { await smoothScrollToTop(screenEl, 420); } catch(e){}
  await sleep(50);

  if (!isTokenLive(token)){ clearing=false; return; }

  screenEl.textContent = "";
  try { screenEl.scrollTop = 0; } catch(e){}

  await nextFrame();
  clearing = false;
}
/* ===== end ===== */

/* === Speech-synced beat system === */
let beatOffTimer = null;
let fallbackBeatTimer = null;

function setBeatScale(scale){
  ballWrap.style.setProperty("--beatScale", String(scale));
}

function triggerBeat(strength = 1){
  const s = Math.max(0.7, Math.min(1.8, strength));
  const scale = (1.0032 + (s - 1) * 0.0045);
  ballWrap.classList.add("beat");
  setBeatScale(scale.toFixed(4));

  clearTimeout(beatOffTimer);
  beatOffTimer = setTimeout(() => {
    ballWrap.classList.remove("beat");
    setBeatScale(ballWrap.classList.contains("speaking") ? "1.0026" : "1.0015");
  }, 130);
}

function startFallbackBeats(){
  stopFallbackBeats();
  const tick = () => {
    if (!ballWrap.classList.contains("speaking")) return;
    const strength = 0.85 + Math.random() * 0.55;
    triggerBeat(strength);
    const next = 120 + Math.random() * 220;
    fallbackBeatTimer = setTimeout(tick, next);
  };
  fallbackBeatTimer = setTimeout(tick, 160);
}

function stopFallbackBeats(){
  clearTimeout(fallbackBeatTimer);
  fallbackBeatTimer = null;
}

let speakingCount = 0;
function setSpeaking(on){
  speakingCount = Math.max(0, speakingCount + (on ? 1 : -1));
  const isSpeaking = speakingCount > 0;

  ballWrap.classList.toggle("speaking", isSpeaking);
  ballWrap.classList.toggle("idle", !isSpeaking);

  setBeatScale(isSpeaking ? "1.0026" : "1.0015");

  if (isSpeaking) startFallbackBeats();
  else stopFallbackBeats();
}

function updateSpeakingFromEngine(){
  try{
    const active = !!(window.speechSynthesis && (speechSynthesis.speaking || speechSynthesis.pending));
    if (active){
      ballWrap.classList.add("speaking");
      ballWrap.classList.remove("idle");
      setBeatScale("1.0026");
      startFallbackBeats();
    }else if (speakingCount === 0){
      ballWrap.classList.remove("speaking");
      ballWrap.classList.add("idle");
      setBeatScale("1.0015");
      stopFallbackBeats();
    }
  }catch(e){}
}

function setButtonsEnabled(on){
  yesBtn.disabled = noBtn.disabled = !on;
}
function setStartEnabled(on){
  startBtn.disabled = !on;
}

function showStopButton(show){
  stopBtn.classList.toggle("placeholder", !show);
  stopBtn.disabled = !show;
  stopBtn.setAttribute("aria-hidden", (!show).toString());
}
  
function paceFactor(){
  const v = speedSel.value;
  return v==="slow" ? 1.35 : v==="fast" ? 0.75 : 1.0;
}
function typeDelayClassic(){
  const v = speedSel.value;
  return v==="slow" ? 26 : v==="fast" ? 9 : 14;
}
function baseSpeechRate(){
  const v = speedSel.value;
  return v === "slow" ? 0.84 : v === "fast" ? 1.25 : 0.98;
}

function syncVoiceLabel(){
  voiceLabel.textContent = speakWhileTyping.checked ? "Voice On" : "Voice Off";
  if (!speakWhileTyping.checked){
    try { speechSynthesis.cancel(); } catch(e) {}
    speakingCount = 0;
    ballWrap.classList.remove("speaking");
    ballWrap.classList.add("idle");
    setBeatScale("1.0015");
    stopFallbackBeats();
  }
}

function hardStopAllAudioAndBeats(){
  try { speechSynthesis.cancel(); } catch(e){}
  speakingCount = 0;
  ballWrap.classList.remove("speaking");
  ballWrap.classList.add("idle");
  ballWrap.style.setProperty("--beatScale","1.0015");
  stopFallbackBeats();
  clearTimeout(beatOffTimer);
}

/* Whoosh sound */
function playGhostlyWhoosh(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;

    const ctx = new AudioCtx();
    if (ctx.state === "suspended") ctx.resume();

    const dur = WHOOSH_MS / 1000;
    const sr = ctx.sampleRate;
    const frames = Math.floor(sr * dur);

    const buf = ctx.createBuffer(1, frames, sr);
    const data = buf.getChannelData(0);
    for (let i = 0; i < frames; i++){
      const white = (Math.random()*2-1);
      const low   = (i ? data[i-1] * 0.90 : 0);
      data[i] = (white * 0.55) + (low * 0.45);
    }

    const src = ctx.createBufferSource();
    src.buffer = buf;

    const filter = ctx.createBiquadFilter();
    filter.type = "lowpass";

    const filter2 = ctx.createBiquadFilter();
    filter2.type = "bandpass";
    filter2.Q.value = 0.9;

    const gain = ctx.createGain();
    const now = ctx.currentTime;

    filter.frequency.setValueAtTime(260, now);
    filter.frequency.exponentialRampToValueAtTime(1550, now + dur*0.62);
    filter.frequency.exponentialRampToValueAtTime(520,  now + dur);

    filter2.frequency.setValueAtTime(320, now);
    filter2.frequency.exponentialRampToValueAtTime(920, now + dur*0.70);
    filter2.frequency.exponentialRampToValueAtTime(420, now + dur);

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.50, now + dur*0.22);
    gain.gain.exponentialRampToValueAtTime(0.16, now + dur*0.78);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    src.connect(filter);
    filter.connect(filter2);
    filter2.connect(gain);
    gain.connect(ctx.destination);

    src.start(now);
    src.stop(now + dur + 0.05);
  }catch(e){}
}

function unlockVoice(){
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance("");
    speechSynthesis.speak(u);
    voiceReady = true;
    setTimeout(selectVoice, 250);
  }catch(e){
    voiceReady = false;
  }
}

function selectVoice(){
  const voices = speechSynthesis.getVoices();
  if (!voices || !voices.length) return;

  let v = voices.find(x => /isha/i.test(x.name || ""));
  if (!v){
    const preferred = ["Samantha","Victoria","Allison","Ava","Anna","Serena","Zoey","Jenny","Aria","Emma","Olivia","Sara"];
    v =
      voices.find(x => preferred.some(n => (x.name||"").toLowerCase().includes(n.toLowerCase())) && (x.lang||"").toLowerCase().startsWith("en"))
      || voices.find(x => (x.lang||"").toLowerCase().startsWith("en"))
      || voices[0];
  }
  chosenVoice = v;
}

if (speechSynthesis.onvoiceschanged !== undefined){
  speechSynthesis.onvoiceschanged = () => selectVoice();
}

async function ensureVoiceSelected(timeoutMs = 1500){
  const start = performance.now();
  while ((!chosenVoice || !voiceReady) && (performance.now() - start) < timeoutMs){
    await sleep(50);
  }
}

function styleParams(){
  const base = baseSpeechRate();
  return { pitch: 1.02, rate: base * 0.95 };
}

function isEllipsisOnly(text){ return text.trim().replace(/[.\u2026]/g, "") === ""; }
function textForSpeech(text){
  let t = text.replace(/\u2026/g, "").replace(/\.{3,}/g, "");
  t = t.replace(/ ?→ ?/g, ". ");
  return t;
}

function splitChunks(full){
  const out = [];
  let buf = "";
  for (let i = 0; i < full.length; i++){
    if (full.slice(i, i+3) === "\n\n\n"){
      if (buf) out.push(buf);
      buf = "";
      out.push("\n\n\n");
      i += 2; continue;
    }
    if (full.slice(i, i+2) === "\n\n"){
      if (buf) out.push(buf);
      buf = "";
      out.push("\n\n");
      i += 1; continue;
    }
    const ch = full[i];
    const next = full[i + 1];
    buf += ch;

    const isEndPunct = (ch==="."||ch==="!"||ch==="?") && (i+1>=full.length || /\s/.test(next));
    const isColonBreak = (ch === ":" && next === "\n");
    if (isEndPunct || isColonBreak){
      out.push(buf);
      buf = "";
    }
  }
  if (buf) out.push(buf);
  return out;
}

function speakSentenceWithStart(text){
  const immediate = { started: Promise.resolve(), done: Promise.resolve(), rateUsed: baseSpeechRate() };
  if (!voiceReady || !chosenVoice) return immediate;
  const part = (text || "").trim();
  if (!part) return immediate;

  const u = new SpeechSynthesisUtterance(textForSpeech(part));
  const style = styleParams();
  u.voice = chosenVoice;
  u.pitch = style.pitch;
  u.rate  = style.rate;
  u.volume = 1.0;

  u.onboundary = (ev) => {
    if (!ev) return;
    if (ev.name === "word" || typeof ev.charIndex === "number"){
      const jitter = 0.85 + Math.random() * 0.55;
      triggerBeat(jitter);
    }
  };

  let startedResolve, doneResolve;
  const started = new Promise(r => (startedResolve = r));
  const done = new Promise(r => (doneResolve = r));

  u.onstart = () => { setSpeaking(true); updateSpeakingFromEngine(); startedResolve(); };
  u.onend   = () => { setSpeaking(false); updateSpeakingFromEngine(); doneResolve(); };
  u.onerror = () => { setSpeaking(false); updateSpeakingFromEngine(); doneResolve(); };

  try{ speechSynthesis.speak(u); }catch(e){ startedResolve(); doneResolve(); }
  return { started, done, rateUsed: u.rate };
}

function estimateSpeechMs(text, rateUsed){
  const t = (text || "").trim();
  if (!t) return 0;
  const words = (t.match(/\S+/g) || []).length;
  const effectiveWpm = 180 * (rateUsed || 1);
  let ms = (words / Math.max(1, effectiveWpm)) * 60_000;
  const punct = (t.match(/[,.!?;:]/g) || []).length;
  ms += punct * 55 * paceFactor();
  return Math.max(360, Math.min(ms, 9000));
}

async function typeChunkOverMs(chunk, totalMs, token){
  const s = chunk || "";
  const chars = Math.max(1, s.length);
  let perChar = totalMs / chars;
  perChar = Math.max(6, Math.min(32, perChar));
  for (const ch of s){
    if (!isTokenLive(token)) return;
    screenEl.textContent += ch;
    autoScrollScreen();
    await sleep(perChar);
  }
}
async function typeChunkClassic(chunk, token){
  for (const ch of (chunk || "")){
    if (!isTokenLive(token)) return;
    screenEl.textContent += ch;
    autoScrollScreen();
    await sleep(typeDelayClassic());
  }
}

async function speakAndTypePerSentence(text, token){
  if (!isTokenLive(token)) return;

  const chunks = splitChunks(text || "");

  for (const chunk of chunks){
    if (!isTokenLive(token)) return;

    const SPEAK_NOW = speakWhileTyping.checked;

    if (chunk === "\n\n" || chunk === "\n\n\n"){
      for (const ch of chunk){
        if (!isTokenLive(token)) return;
        screenEl.textContent += ch;
        autoScrollScreen();
        await sleep(8);
      }
      updateSpeakingFromEngine();
      await sleep((chunk === "\n\n\n" ? SECTION_PAUSE_MS : PARAGRAPH_PAUSE_MS) * paceFactor());
      continue;
    }

    if (isEllipsisOnly(chunk)){
      if (speakingCount === 0) updateSpeakingFromEngine();
      const dots = (chunk.match(/[.\u2026]/g) || []).length || 3;
      for (let i = 0; i < dots; i++){
        if (!isTokenLive(token)) return;
        screenEl.textContent += "…";
        autoScrollScreen();
        updateSpeakingFromEngine();
        await sleep(((i === dots - 1) ? FINAL_ELLIPSIS_DELAY : ELLIPSIS_DELAY) * paceFactor());
      }
      continue;
    }

    if (!SPEAK_NOW){
      await typeChunkClassic(chunk, token);
      updateSpeakingFromEngine();
      await sleep(SENTENCE_PAUSE_MS * paceFactor());
      continue;
    }

    const speech = speakSentenceWithStart(chunk);
    const canSpeak = voiceReady && chosenVoice && SPEAK_NOW;

    if (!LIVE_SYNC || !canSpeak){
      await typeChunkClassic(chunk, token);
      await speech.done;
      updateSpeakingFromEngine();
      await sleep(SENTENCE_PAUSE_MS * paceFactor());
      continue;
    }

    await speech.started;
    await typeChunkOverMs(chunk, estimateSpeechMs(chunk, speech.rateUsed), token);
    await speech.done;
    updateSpeakingFromEngine();
    await sleep(SENTENCE_PAUSE_MS * paceFactor());
  }

  updateSpeakingFromEngine();
}

/* =========================
   PANIC BUTTON: instant End Session
   ========================= */
async function forceEndSession(){
  // Cancel any typing loops immediately
  const token = bumpRunToken();

  // Stop voice/beat immediately
  hardStopAllAudioAndBeats();

  // Abort any in-flight fetch immediately
  abortInFlightFetch();

  // Mark ended and release locks
  sessionDone = true;
  chooseInFlight = false;
  startInFlight = false;

  // Lock buttons
  yesBtn.disabled = true;
  noBtn.disabled = true;
  stopBtn.disabled = true;

  // Clear and show goodbye via teletype + speech
  screenEl.textContent = "";
  autoScrollScreen();

  const goodbye =
`Sorry to see you go.
Come back another time…
The words will be waiting for your call.`;

  await speakAndTypePerSentence(goodbye, token);

  statusEl.textContent = "Session ended. Press Start to begin again.";
  setStartEnabled(true);

  // Best-effort notify backend (non-blocking)
  try{
    fetch(`${API}/choose`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ answer: "stop", context: { session_id: sessionId } }),
      keepalive: true
    }).catch(()=>{});
  }catch(e){}
}

/* ========================= */

async function startSession(token){
  try{
    statusEl.textContent = "";
    sessionDone = false;
    showStopButton(true);   // ← ADD THIS LINE
    // allow End session as soon as the session starts
    stopBtn.disabled = false;

    setButtonsEnabled(false);

    await gentleResetAndClear(token);
    if (!isTokenLive(token)) return;

    abortInFlightFetch();
    currentFetchController = new AbortController();

    const res = await fetch(`${API}/start`, {
      credentials:"include",
      signal: currentFetchController.signal
    });
    if(!res.ok) throw new Error(`Start failed: ${res.status} ${res.statusText}`);
    const data = await res.json();
    if (!isTokenLive(token)) return;

    sessionId = data.session_id || sessionId;

    // IMPORTANT: your backend returns guidance/prompt in some versions.
    // We support either.
    if (data.prompt)   await speakAndTypePerSentence(normalizeCTA(trimLeadingNewlines(data.prompt)), token);
    if (data.guidance) await speakAndTypePerSentence(normalizeCTA(trimLeadingNewlines(data.guidance)), token);

    if (!isTokenLive(token)) return;
    setButtonsEnabled(true);
  }catch(err){
    if (!isTokenLive(token)) return;
    screenEl.textContent = `⚠️ Could not reach backend at ${API}/start\n${String(err)}`;
    setButtonsEnabled(false);
    stopBtn.disabled = true;
    setStartEnabled(true);
  }
}

async function sendChoice(answer){
  // Anti-double-click for Yes/No only
  if (chooseInFlight) return;
  if (sessionDone) return;

  chooseInFlight = true;
  const token = runToken;

  try{
    setButtonsEnabled(false);

    await gentleResetAndClear(token);
    if (!isTokenLive(token)) return;

    abortInFlightFetch();
    currentFetchController = new AbortController();

    const res = await fetch(`${API}/choose`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        answer,
        context: { session_id: sessionId } // critical to prevent repeats
      }),
      signal: currentFetchController.signal
    });

    if(!res.ok) throw new Error(`Choose failed: ${res.status} ${res.statusText}`);
    const data = await res.json();
    if (!isTokenLive(token)) return;

    if (data.context?.session_id) sessionId = data.context.session_id;

    if (data.text) await speakAndTypePerSentence(normalizeCTA(trimLeadingNewlines(data.text)), token);

    if (!isTokenLive(token)) return;

    const done = !!data.done;
    sessionDone = done;

    if (done){
      yesBtn.disabled = true;
      noBtn.disabled = true;
      stopBtn.disabled = true;
      statusEl.textContent = "Session ended. Press Start to begin again.";
      setStartEnabled(true);
    }else{
      setButtonsEnabled(true);
      stopBtn.disabled = false; // keep end session available at all times
    }
  }catch(err){
    if (!isTokenLive(runToken)) return;
    screenEl.textContent = `⚠️ Request failed to ${API}/choose\n${String(err)}`;
    if (!sessionDone){
      setButtonsEnabled(true);
      stopBtn.disabled = false;
    }
  }finally{
    chooseInFlight = false;
  }
}

function bindStartOnce(){
  if (startBound) return;
  startBound = true;

  startBtn.addEventListener("click", async (e)=>{
    e.preventDefault();

    if (startInFlight) return;
    startInFlight = true;

    const token = bumpRunToken();

    // lock UI
    setStartEnabled(false);
    setButtonsEnabled(false);
    stopBtn.disabled = true;
    statusEl.textContent = "";

    // stop any existing noise
    abortInFlightFetch();
    hardStopAllAudioAndBeats();

    // reset session state
    sessionId = null;
    sessionDone = false;
    chooseInFlight = false;

    // title + whoosh once
    if (!titleShown){
      titleShown = true;
      playGhostlyWhoosh();
      if (titleEl) titleEl.classList.add("visible");
    }

    await sleep(WHOOSH_MS + WHOOSH_BUFFER_MS);
    if (!isTokenLive(token)){ startInFlight = false; return; }

    unlockVoice();
    await ensureVoiceSelected();
    if (!isTokenLive(token)){ startInFlight = false; return; }

    await startSession(token);

    startInFlight = false;
  });
}

bindStartOnce();
yesBtn.addEventListener("click", (e)=>{ e.preventDefault(); sendChoice("yes"); });
noBtn.addEventListener("click",  (e)=>{ e.preventDefault(); sendChoice("no");  });

// ✅ End session is now a true panic button (works even mid-typing / mid-speech / mid-fetch)
stopBtn.addEventListener("click", (e)=>{ e.preventDefault(); forceEndSession(); });

speakWhileTyping.addEventListener("change", syncVoiceLabel);

// initial UI state
setButtonsEnabled(false);
setStartEnabled(true);
showStopButton(false);
syncVoiceLabel();
</script>
</body>
</html>
